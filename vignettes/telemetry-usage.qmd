---
title: "LLM Usage & Costs"
author: "John Gavin"
date: "`r Sys.Date()`"
format: 
  html:
    toc: true
    toc-depth: 3
    page-layout: full
    code-fold: true
vignette: >
  %\VignetteIndexEntry{LLM Usage & Costs}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

## LLM Usage Dashboard

This dashboard provides a snapshot of current LLM consumption against daily and weekly limits.

```{r usage-setup}
library(llm)
library(here)
library(scales)
library(dplyr)
library(tidyr)
library(ggplot2)
library(gt)
library(gtExtras)

# Load cached data
daily_data <- load_cached_ccusage("daily", project_filter = NULL)
session_data <- load_cached_ccusage("session", project_filter = NULL)
has_gt <- TRUE 
```

```{r dashboard-status}
#| results: "asis"
#| comment: ""

if (!is.null(daily_data) && nrow(daily_data) > 0) {
  # Static summary table for report
  summary_stats <- summarize_llm_usage(daily_data)
  
  summary_stats |>
    gt() |>
    tab_header(
      title = "LLM Usage Status",
      subtitle = "Current usage against limits"
    ) |>
    cols_label(
      metric = "Metric",
      value = "Value"
    ) |>
    tab_options(
      table.font.size = px(14),
      heading.title.font.size = px(18)
    )
} else {
  cat("No data available for dashboard.\n")
}
```

::: {.panel-tabset}

### Cost Trends

```{r cost-trend}
#| fig-cap: "Daily LLM costs over time"
if (!is.null(daily_data) && nrow(daily_data) > 0) {
  cost_trend <- daily_data |>
    mutate(date = as.Date(date)) |>
    group_by(date) |>
    summarise(
      daily_cost = sum(totalCost, na.rm = TRUE),
      .groups = "drop"
    ) |>
    arrange(date)

  ggplot(cost_trend, aes(x = date, y = daily_cost)) + 
    geom_col(fill = "steelblue", alpha = 0.7) +
    geom_smooth(method = "loess", se = FALSE, color = "darkred", linewidth = 1) +
    scale_y_continuous(labels = dollar_format()) +
    labs(
      title = "Daily LLM Costs",
      x = "Date",
      y = "Cost (USD)"
    ) +
    theme_minimal()
}
```

### Cumulative Cost

```{r cumulative-cost}
#| fig-cap: "Cumulative LLM spending"
if (!is.null(daily_data) && nrow(daily_data) > 0) {
  cumulative_cost <- daily_data |>
    mutate(date = as.Date(date)) |>
    group_by(date) |>
    summarise(daily_cost = sum(totalCost, na.rm = TRUE), .groups = "drop") |>
    arrange(date) |>
    mutate(cumulative_cost = cumsum(daily_cost))

  ggplot(cumulative_cost, aes(x = date, y = cumulative_cost)) + 
    geom_area(fill = "steelblue", alpha = 0.3) +
    geom_line(color = "steelblue", linewidth = 1) +
    geom_point(color = "darkblue", size = 2) +
    scale_y_continuous(labels = dollar_format()) +
    labs(
      title = "Cumulative LLM Spending",
      x = "Date",
      y = "Cumulative Cost (USD)"
    ) +
    theme_minimal()
}
```

:::

## Breakdowns

::: {.panel-tabset}

### By Model (Cost)

```{r model-cost}
if (!is.null(daily_data) && nrow(daily_data) > 0) {
  model_costs <- get_model_breakdown(daily_data)
  if (!is.null(model_costs) && nrow(model_costs) > 0) {
    ggplot(model_costs, aes(x = reorder(modelName, total_cost), y = total_cost)) + 
      geom_col(fill = "steelblue", alpha = 0.8) +
      geom_text(aes(label = dollar(total_cost)), hjust = -0.1, size = 3.5) +
      coord_flip() +
      scale_y_continuous(labels = dollar_format(), expand = expansion(mult = c(0, 0.15))) +
      labs(title = "Total Cost by Model", x = NULL, y = "Total Cost (USD)") +
      theme_minimal()
  }
}
```

### By Token Type

```{r token-type}
if (!is.null(daily_data) && nrow(daily_data) > 0) {
  token_data <- daily_data |>
    mutate(date = as.Date(date)) |>
    group_by(date) |>
    summarise(
      Input = sum(inputTokens, na.rm = TRUE),
      Output = sum(outputTokens, na.rm = TRUE),
      `Cache Creation` = sum(cacheCreationTokens, na.rm = TRUE),
      `Cache Read` = sum(cacheReadTokens, na.rm = TRUE),
      .groups = "drop"
    ) |>
    pivot_longer(cols = -date, names_to = "token_type", values_to = "tokens")

  ggplot(token_data, aes(x = date, y = tokens / 1e6, fill = token_type)) + 
    geom_col(position = "stack", alpha = 0.8) +
    scale_fill_brewer(palette = "Set2") +
    scale_y_continuous(labels = label_comma(suffix = "M")) +
    labs(title = "Token Usage by Type", y = "Tokens (millions)") +
    theme_minimal() + theme(legend.position = "bottom")
}
```

:::

## Gemini Analytics

```{r gemini-analysis}
library(DBI)
library(duckdb)

gm_db_path <- here::here("inst/extdata/gemini_usage.duckdb")
has_gemini <- file.exists(gm_db_path)

if (has_gemini) {
  con <- dbConnect(duckdb(), dbdir = gm_db_path, read_only = TRUE)
  gm_daily <- dbGetQuery(con, "SELECT * FROM daily_usage ORDER BY date")
  dbDisconnect(con, shutdown = TRUE)
  
  if (nrow(gm_daily) > 0) {
    p1 <- ggplot(gm_daily, aes(x = as.Date(date), y = total_cost)) + 
      geom_col(fill = "#4fc3f7", alpha = 0.7) +
      scale_y_continuous(labels = dollar_format()) +
      labs(title = "Gemini Daily Costs", x = "Date", y = "Cost (USD)") +
      theme_minimal()
      
    print(p1)
  }
} else {
  cat("No Gemini data available.")
}
```