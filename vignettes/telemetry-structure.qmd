---
title: "Project Structure"
author: "John Gavin"
date: "`r Sys.Date()`"
format: 
  html:
    toc: true
    toc-depth: 3
    page-layout: full
    code-fold: true
vignette: >
  %\VignetteIndexEntry{Project Structure}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
library(fs)
library(gh)
library(tibble)
library(dplyr)
library(knitr)
library(lubridate)

owner <- "JohnGavin"
repo <- "llm"
```

::: {.panel-tabset}

## Directory Structure

```{r dir-tree}
#| comment: ""
tryCatch({
  tree_output <- capture.output(fs::dir_tree(recurse = 2))
  cat(paste(head(tree_output, 50), collapse = "\n"))
}, error = function(e) cat("Tree generation failed"))
```

## File Counts

```{r file-counts}
all_files <- tryCatch({
  fs::dir_ls(recurse = TRUE, type = "file") |>
    as.character() |>
    {\(x) x[!grepl("(\\.git|_targets|renv)", x)]}()
}, error = function(e) character(0))

if (length(all_files) > 0) {
  file_counts <- tibble(path = all_files) |>
    mutate(extension = tools::file_ext(path)) |>
    count(extension, name = "count") |>
    arrange(desc(count))
  kable(head(file_counts, 20))
}
```

## GitHub Stats

```{r github-stats}
# Fetch comprehensive stats
stats <- tryCatch({
  repo_info <- gh::gh("/repos/{owner}/{repo}", owner = owner, repo = repo)
  branches <- gh::gh("/repos/{owner}/{repo}/branches", owner = owner, repo = repo)
  
  # For commits, we check the latest from the default branch
  commits <- gh::gh("/repos/{owner}/{repo}/commits", owner = owner, repo = repo, per_page = 1)
  
  # Fetch closed PRs count (merged into main)
  merged_prs <- gh::gh("/repos/{owner}/{repo}/pulls", owner = owner, repo = repo, state = "closed", per_page = 1)
  merged_count <- attr(merged_prs, "responseHeader") [["link"]]
  # Simple heuristic if pagination header exists
  merged_count_val <- if (!is.null(merged_count)) "Many" else length(merged_prs)

  list(
    info = repo_info,
    branch_count = length(branches),
    latest_commit = commits[[1]]$commit$committer$date,
    merged_prs = merged_count_val
  )
}, error = function(e) NULL)

if (!is.null(stats)) {
  stats_table <- tibble(
    Metric = c(
      "Stars", 
      "Forks", 
      "Open Issues", 
      "Total Branches", 
      "Last Commit",
      "Recent Merged PRs"
    ),
    Value = c(
      as.character(stats$info$stargazers_count), 
      as.character(stats$info$forks_count), 
      as.character(stats$info$open_issues_count),
      as.character(stats$branch_count),
      as.character(as.Date(ymd_hms(stats$latest_commit))),
      as.character(stats$merged_prs)
    )
  )
  kable(stats_table)
} else {
  cat("Failed to fetch GitHub stats.")
}
```

:::