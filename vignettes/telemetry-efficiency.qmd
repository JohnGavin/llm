---
title: "Session Efficiency"
author: "John Gavin"
date: "`r Sys.Date()`"
format: 
  html:
    toc: true
    toc-depth: 3
    page-layout: full
    code-fold: true
vignette: >
  %\VignetteIndexEntry{Session Efficiency}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#",
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

```{r efficiency-setup}
library(llm)
library(here)
library(scales)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(jsonlite)
library(gridExtra)
library(DT)

# Load blocks data
blocks_data <- tryCatch({
  jsonlite::fromJSON(here::here("inst/extdata/ccusage_blocks_all.json"))
}, error = function(e) NULL)
```

## Session Efficiency & Cost Analysis

This section analyzes long-term trends in session duration and cost efficiency.

```{r session-metrics-prep}
if (!is.null(blocks_data) && !is.null(blocks_data$blocks)) {
  # Process blocks to session level
  session_metrics <- as_tibble(blocks_data$blocks) |>
    mutate(
      start = ymd_hms(startTime),
      end = ymd_hms(actualEndTime),
      duration_mins = as.numeric(difftime(end, start, units = "mins")),
      date = as.Date(start),
      cost_per_min = ifelse(duration_mins > 0, costUSD / duration_mins, 0),
      weeks_ago = as.numeric(difftime(Sys.Date(), date, units = "weeks"))
    ) |>
    mutate(
      time_period = case_when(
        weeks_ago <= 1 ~ "Last 1 week",
        weeks_ago <= 2 ~ "Last 2 weeks",
        weeks_ago <= 3 ~ "Last 3 weeks",
        weeks_ago <= 4 ~ "Last 4 weeks",
        TRUE ~ ">4 weeks"
      ),
      time_period = factor(time_period, levels = c("Last 1 week", "Last 2 weeks", "Last 3 weeks", "Last 4 weeks", ">4 weeks"))
    ) |>
    filter(!is.na(end), duration_mins > 0, costUSD > 0)
}
```

::: {.panel-tabset}

### Duration Trends

```{r duration-trend}
if (exists("session_metrics")) {
  daily_trends <- session_metrics |>
    group_by(date, time_period) |>
    summarise(avg_duration = mean(duration_mins), .groups = "drop")

  ggplot(daily_trends, aes(x = date, y = avg_duration)) + 
    geom_point(aes(color = time_period), alpha = 0.7, size = 2) +
    geom_smooth(method = "loess", se = FALSE, color = "darkblue") +
    scale_color_brewer(palette = "Set1") +
    labs(
      title = "Average Session Duration Over Time",
      subtitle = "Colored by recency",
      y = "Avg Duration (mins)"
    ) +
    theme_minimal()
}
```

### Cost Efficiency

```{r cost-efficiency}
if (exists("session_metrics")) {
  daily_cost <- session_metrics |>
    group_by(date, time_period) |>
    summarise(avg_cost_min = mean(cost_per_min), .groups = "drop")

  ggplot(daily_cost, aes(x = date, y = avg_cost_min)) + 
    geom_point(aes(color = time_period), alpha = 0.7, size = 2) +
    geom_smooth(method = "loess", se = FALSE, color = "darkgreen") +
    scale_color_brewer(palette = "Set1") +
    scale_y_continuous(labels = dollar_format())
    labs(
      title = "Cost per Minute Over Time",
      y = "Avg Cost / Minute ($)"
    ) +
    theme_minimal()
}
```

### Cost vs Duration (Linear)

```{r cost-duration-linear}
if (exists("session_metrics")) {
  ggplot(session_metrics, aes(x = duration_mins, y = cost_per_min)) + 
    geom_point(aes(color = time_period), alpha = 0.6) +
    geom_smooth(method = "loess", color = "red") +
    scale_color_brewer(palette = "Set1") +
    scale_y_continuous(labels = dollar_format())
    labs(
      title = "Cost Intensity vs Duration",
      subtitle = "Linear scale with LOESS smoother",
      x = "Duration (mins)",
      y = "Cost/Min ($)"
    ) +
    theme_minimal()
}
```

### Model Breakdown

```{r model-breakdown-panels}
#| fig-height: 8

if (exists("session_metrics")) {
  # Unnest models to see usage per model
  # Assuming 'models' column is a list of character vectors
  model_usage <- session_metrics |>
    select(date, duration_mins, cost_per_min, models) |>
    tidyr::unnest(models) |>
    mutate(model_clean = gsub("claude-", "", models))

  ggplot(model_usage, aes(x = date, y = cost_per_min)) + 
    geom_point(alpha = 0.4, color = "steelblue") +
    geom_smooth(method = "loess", se = FALSE, color = "darkred") +
    facet_wrap(~model_clean, scales = "free_y", ncol = 2) +
    scale_y_continuous(labels = dollar_format())
    labs(
      title = "Cost Efficiency by Model",
      y = "Cost/Min ($)"
    ) +
    theme_minimal()
}
```

:::

## Max5 Block History

Recent history of 5-hour token usage blocks.

```{r max5-history-static}
if (exists("session_metrics")) {
  # Create a static table for Max5 blocks
  max5_table <- session_metrics |>
    arrange(desc(start)) |>
    head(10) |>
    select(date, start, end, duration_mins, costUSD, totalTokens) |>
    mutate(
      Duration = sprintf("%02d:%02d", as.integer(duration_mins %/% 60), as.integer(duration_mins %% 60)),
      Cost = dollar(costUSD),
      Tokens = comma(totalTokens)
    ) |>
    select(Start = start, End = end, Duration, Cost, Tokens)

  knitr::kable(max5_table, caption = "Last 10 Usage Blocks")
} else {
  cat("No block history available.\n")
}
```
